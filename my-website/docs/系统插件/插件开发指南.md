---
sidebar_position: 2
---

# 插件开发指南

本指南将详细介绍如何开发 FastGPT 系统插件，从环境搭建到插件发布的完整流程。

## 开发环境搭建

### 1. 环境要求

开发插件需要以下环境：

- **Node.js**：版本 >= 16.0.0
- **npm 或 yarn**：包管理工具
- **Git**：版本控制工具
- **代码编辑器**：推荐 VS Code

### 2. SDK 安装

安装 FastGPT 插件开发 SDK：

```bash
# 全局安装 CLI 工具
npm install -g @fastgpt/plugin-cli

# 创建新插件项目
fastgpt-plugin create my-plugin

# 进入项目目录
cd my-plugin

# 安装依赖
npm install
```

### 3. 项目结构

创建的插件项目结构如下：

```
my-plugin/
├── package.json              # 项目配置
├── plugin.json              # 插件定义
├── README.md                # 项目说明
├── src/                     # 源码目录
│   ├── index.ts             # 插件入口
│   ├── handlers/            # 处理器目录
│   │   └── main.ts          # 主处理器
│   ├── config/              # 配置相关
│   │   ├── schema.json      # 配置模式
│   │   └── defaults.json    # 默认配置
│   ├── utils/               # 工具函数
│   │   └── helpers.ts       # 辅助函数
│   └── types/               # 类型定义
│       └── index.ts         # 类型声明
├── templates/               # 模板文件
│   ├── config.html          # 配置界面
│   └── help.html            # 帮助文档
├── tests/                   # 测试文件
│   ├── unit/                # 单元测试
│   └── integration/         # 集成测试
├── docs/                    # 文档目录
│   └── api.md               # API 文档
└── dist/                    # 构建输出
```

## 插件开发

### 1. 插件定义

编辑 `plugin.json` 文件定义插件基本信息：

```json
{
  "id": "my-custom-plugin",
  "name": "我的自定义插件",
  "version": "1.0.0",
  "description": "这是一个示例插件，展示如何开发自定义功能",
  "author": {
    "name": "开发者姓名",
    "email": "developer@example.com",
    "url": "https://github.com/developer"
  },
  "license": "MIT",
  "keywords": ["fastgpt", "plugin", "custom"],
  "repository": {
    "type": "git",
    "url": "https://github.com/developer/my-plugin"
  },
  "type": "tool",
  "category": "数据处理",
  "icon": "/static/icon.png",
  "tags": ["数据", "处理", "工具"],
  "config": {
    "schema": "./src/config/schema.json",
    "template": "./templates/config.html",
    "defaults": "./src/config/defaults.json"
  },
  "handlers": {
    "main": "./src/handlers/main.ts",
    "validate": "./src/handlers/validate.ts"
  },
  "permissions": [
    "http.request",
    "file.read",
    "storage.read",
    "storage.write"
  ],
  "dependencies": {
    "axios": "^1.0.0",
    "lodash": "^4.17.0"
  },
  "engines": {
    "node": ">=16.0.0",
    "fastgpt": ">=2.0.0"
  }
}
```

### 2. 配置模式定义

在 `src/config/schema.json` 中定义配置项：

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "title": "插件配置",
  "description": "配置插件的参数和选项",
  "properties": {
    "apiUrl": {
      "type": "string",
      "title": "API 地址",
      "description": "外部 API 的地址",
      "format": "uri",
      "pattern": "^https?://",
      "minLength": 1,
      "maxLength": 500
    },
    "apiKey": {
      "type": "string",
      "title": "API 密钥",
      "description": "访问 API 的认证密钥",
      "minLength": 1,
      "maxLength": 100,
      "pattern": "^[a-zA-Z0-9_-]+$"
    },
    "timeout": {
      "type": "integer",
      "title": "超时时间",
      "description": "请求超时时间（秒）",
      "minimum": 1,
      "maximum": 300,
      "default": 30
    },
    "enableCache": {
      "type": "boolean",
      "title": "启用缓存",
      "description": "是否启用响应缓存",
      "default": true
    },
    "cacheExpiry": {
      "type": "integer",
      "title": "缓存过期时间",
      "description": "缓存过期时间（分钟）",
      "minimum": 1,
      "maximum": 1440,
      "default": 60,
      "condition": {
        "enableCache": true
      }
    },
    "retryCount": {
      "type": "integer",
      "title": "重试次数",
      "description": "失败时的重试次数",
      "minimum": 0,
      "maximum": 5,
      "default": 2
    },
    "headers": {
      "type": "object",
      "title": "自定义请求头",
      "description": "额外的 HTTP 请求头",
      "patternProperties": {
        "^[a-zA-Z0-9-]+$": {
          "type": "string"
        }
      },
      "additionalProperties": false
    }
  },
  "required": ["apiUrl", "apiKey"],
  "additionalProperties": false
}
```

### 3. 主处理器实现

在 `src/handlers/main.ts` 中实现主要逻辑：

```typescript
import { PluginHandler, PluginContext, PluginInput, PluginOutput } from '@fastgpt/plugin-sdk';
import axios, { AxiosRequestConfig } from 'axios';
import { Logger } from '../utils/logger';
import { CacheManager } from '../utils/cache';

interface PluginConfig {
  apiUrl: string;
  apiKey: string;
  timeout: number;
  enableCache: boolean;
  cacheExpiry: number;
  retryCount: number;
  headers?: Record<string, string>;
}

interface InputData {
  query: string;
  parameters?: Record<string, any>;
  options?: {
    format?: 'json' | 'text' | 'xml';
    method?: 'GET' | 'POST' | 'PUT' | 'DELETE';
  };
}

export class MainHandler extends PluginHandler<PluginConfig> {
  private logger: Logger;
  private cache: CacheManager;

  constructor(config: PluginConfig, context: PluginContext) {
    super(config, context);
    this.logger = new Logger('MainHandler');
    this.cache = new CacheManager({
      enabled: config.enableCache,
      expiry: config.cacheExpiry * 60 * 1000 // 转换为毫秒
    });
  }

  /**
   * 插件主执行方法
   */
  async execute(input: PluginInput<InputData>): Promise<PluginOutput> {
    try {
      this.logger.info('开始执行插件', { input });

      // 验证输入数据
      const validatedInput = await this.validateInput(input.data);

      // 检查缓存
      const cacheKey = this.generateCacheKey(validatedInput);
      if (this.config.enableCache) {
        const cachedResult = await this.cache.get(cacheKey);
        if (cachedResult) {
          this.logger.info('返回缓存结果');
          return {
            success: true,
            data: cachedResult,
            cached: true,
            message: '数据获取成功（缓存）'
          };
        }
      }

      // 执行主要逻辑
      const result = await this.processRequest(validatedInput);

      // 缓存结果
      if (this.config.enableCache && result) {
        await this.cache.set(cacheKey, result);
      }

      this.logger.info('插件执行成功', { result });

      return {
        success: true,
        data: result,
        cached: false,
        message: '数据获取成功'
      };

    } catch (error) {
      this.logger.error('插件执行失败', error);
      
      return {
        success: false,
        error: {
          code: error.code || 'PLUGIN_ERROR',
          message: error.message || '未知错误',
          details: error.details || {}
        },
        message: '处理失败'
      };
    }
  }

  /**
   * 验证输入数据
   */
  private async validateInput(data: InputData): Promise<InputData> {
    if (!data.query || typeof data.query !== 'string') {
      throw new Error('查询参数不能为空');
    }

    if (data.query.length > 1000) {
      throw new Error('查询参数过长，最大长度为1000个字符');
    }

    // 清理和标准化数据
    return {
      query: data.query.trim(),
      parameters: data.parameters || {},
      options: {
        format: data.options?.format || 'json',
        method: data.options?.method || 'GET'
      }
    };
  }

  /**
   * 处理请求
   */
  private async processRequest(input: InputData): Promise<any> {
    const requestConfig: AxiosRequestConfig = {
      url: this.buildUrl(input),
      method: input.options.method,
      timeout: this.config.timeout * 1000,
      headers: {
        'Authorization': `Bearer ${this.config.apiKey}`,
        'Content-Type': 'application/json',
        'User-Agent': 'FastGPT-Plugin/1.0',
        ...this.config.headers
      }
    };

    // 根据方法添加数据
    if (input.options.method === 'POST' || input.options.method === 'PUT') {
      requestConfig.data = {
        query: input.query,
        ...input.parameters
      };
    } else {
      requestConfig.params = {
        q: input.query,
        ...input.parameters
      };
    }

    // 执行请求，支持重试
    let lastError: Error;
    for (let attempt = 0; attempt <= this.config.retryCount; attempt++) {
      try {
        this.logger.info(`执行请求，尝试 ${attempt + 1}/${this.config.retryCount + 1}`, {
          url: requestConfig.url,
          method: requestConfig.method
        });

        const response = await axios(requestConfig);
        
        // 处理响应数据
        return this.processResponse(response.data, input.options.format);
        
      } catch (error) {
        lastError = error;
        this.logger.warn(`请求失败，尝试 ${attempt + 1}`, error.message);
        
        // 如果是最后一次尝试，或者是不可重试的错误，直接抛出
        if (attempt === this.config.retryCount || this.isNonRetryableError(error)) {
          break;
        }
        
        // 等待后重试
        await this.sleep(Math.pow(2, attempt) * 1000);
      }
    }

    throw lastError;
  }

  /**
   * 构建请求 URL
   */
  private buildUrl(input: InputData): string {
    const baseUrl = this.config.apiUrl.replace(/\/$/, '');
    return `${baseUrl}/search`;
  }

  /**
   * 处理响应数据
   */
  private processResponse(data: any, format: string): any {
    switch (format) {
      case 'json':
        return data;
      case 'text':
        return typeof data === 'string' ? data : JSON.stringify(data);
      case 'xml':
        return this.convertToXml(data);
      default:
        return data;
    }
  }

  /**
   * 生成缓存键
   */
  private generateCacheKey(input: InputData): string {
    const key = JSON.stringify({
      query: input.query,
      parameters: input.parameters,
      options: input.options
    });
    return `plugin:${this.context.pluginId}:${this.hash(key)}`;
  }

  /**
   * 判断是否为不可重试的错误
   */
  private isNonRetryableError(error: any): boolean {
    if (error.response) {
      const status = error.response.status;
      // 4xx 错误通常不需要重试
      return status >= 400 && status < 500;
    }
    return false;
  }

  /**
   * 睡眠函数
   */
  private sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  /**
   * 哈希函数
   */
  private hash(str: string): string {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; // 转换为32位整数
    }
    return Math.abs(hash).toString(16);
  }

  /**
   * 转换为 XML 格式
   */
  private convertToXml(data: any): string {
    // 简单的 JSON 到 XML 转换
    const xmlify = (obj: any, indent: string = ''): string => {
      if (typeof obj !== 'object' || obj === null) {
        return String(obj);
      }
      
      let xml = '';
      for (const [key, value] of Object.entries(obj)) {
        if (Array.isArray(value)) {
          for (const item of value) {
            xml += `${indent}<${key}>${xmlify(item, indent + '  ')}</${key}>\n`;
          }
        } else {
          xml += `${indent}<${key}>${xmlify(value, indent + '  ')}</${key}>\n`;
        }
      }
      return xml;
    };
    
    return `<?xml version="1.0" encoding="UTF-8"?>\n<root>\n${xmlify(data, '  ')}</root>`;
  }
}
```

### 4. 工具函数

创建常用的工具函数：

```typescript
// src/utils/logger.ts
export class Logger {
  constructor(private context: string) {}

  info(message: string, data?: any) {
    console.log(`[${this.context}] INFO: ${message}`, data || '');
  }

  warn(message: string, data?: any) {
    console.warn(`[${this.context}] WARN: ${message}`, data || '');
  }

  error(message: string, error?: any) {
    console.error(`[${this.context}] ERROR: ${message}`, error || '');
  }
}

// src/utils/cache.ts
export class CacheManager {
  private cache = new Map<string, { data: any; expiry: number }>();

  constructor(private options: { enabled: boolean; expiry: number }) {}

  async get(key: string): Promise<any> {
    if (!this.options.enabled) return null;

    const item = this.cache.get(key);
    if (!item) return null;

    if (Date.now() > item.expiry) {
      this.cache.delete(key);
      return null;
    }

    return item.data;
  }

  async set(key: string, data: any): Promise<void> {
    if (!this.options.enabled) return;

    this.cache.set(key, {
      data,
      expiry: Date.now() + this.options.expiry
    });
  }

  async clear(): Promise<void> {
    this.cache.clear();
  }
}
```

### 5. 配置界面

创建用户友好的配置界面：

```html
<!-- templates/config.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>插件配置</title>
    <style>
        .config-form {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .form-group .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .form-group.checkbox {
            display: flex;
            align-items: center;
        }
        
        .form-group.checkbox input {
            width: auto;
            margin-right: 8px;
        }
        
        .advanced-options {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="config-form">
        <h2>插件配置</h2>
        
        <form id="pluginConfigForm">
            <!-- 基础配置 -->
            <div class="form-group">
                <label for="apiUrl">API 地址 *</label>
                <input 
                    type="url" 
                    id="apiUrl" 
                    name="apiUrl" 
                    placeholder="https://api.example.com"
                    required
                />
                <div class="help-text">外部 API 的完整地址</div>
                <div class="error" id="apiUrl-error"></div>
            </div>
            
            <div class="form-group">
                <label for="apiKey">API 密钥 *</label>
                <input 
                    type="password" 
                    id="apiKey" 
                    name="apiKey" 
                    placeholder="请输入 API 密钥"
                    required
                />
                <div class="help-text">用于认证的 API 密钥</div>
                <div class="error" id="apiKey-error"></div>
            </div>
            
            <div class="form-group">
                <label for="timeout">超时时间（秒）</label>
                <input 
                    type="number" 
                    id="timeout" 
                    name="timeout" 
                    value="30"
                    min="1" 
                    max="300"
                />
                <div class="help-text">请求超时时间，范围 1-300 秒</div>
            </div>
            
            <!-- 缓存配置 -->
            <div class="form-group checkbox">
                <input type="checkbox" id="enableCache" name="enableCache" checked />
                <label for="enableCache">启用缓存</label>
            </div>
            
            <div class="form-group" id="cacheExpiryGroup">
                <label for="cacheExpiry">缓存过期时间（分钟）</label>
                <input 
                    type="number" 
                    id="cacheExpiry" 
                    name="cacheExpiry" 
                    value="60"
                    min="1" 
                    max="1440"
                />
                <div class="help-text">缓存数据的过期时间</div>
            </div>
            
            <!-- 高级选项 -->
            <div class="advanced-options">
                <div class="section-title">高级选项</div>
                
                <div class="form-group">
                    <label for="retryCount">重试次数</label>
                    <select id="retryCount" name="retryCount">
                        <option value="0">不重试</option>
                        <option value="1">1次</option>
                        <option value="2" selected>2次</option>
                        <option value="3">3次</option>
                        <option value="5">5次</option>
                    </select>
                    <div class="help-text">请求失败时的重试次数</div>
                </div>
                
                <div class="form-group">
                    <label for="headers">自定义请求头（JSON格式）</label>
                    <textarea 
                        id="headers" 
                        name="headers" 
                        rows="4"
                        placeholder='{"X-Custom-Header": "value"}'
                    ></textarea>
                    <div class="help-text">额外的 HTTP 请求头，使用 JSON 格式</div>
                    <div class="error" id="headers-error"></div>
                </div>
            </div>
        </form>
    </div>

    <script>
        // 缓存选项显示/隐藏
        const enableCacheCheckbox = document.getElementById('enableCache');
        const cacheExpiryGroup = document.getElementById('cacheExpiryGroup');
        
        enableCacheCheckbox.addEventListener('change', function() {
            cacheExpiryGroup.style.display = this.checked ? 'block' : 'none';
        });
        
        // 表单验证
        const form = document.getElementById('pluginConfigForm');
        
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            validateForm();
        });
        
        function validateForm() {
            clearErrors();
            
            let isValid = true;
            
            // 验证 API URL
            const apiUrl = document.getElementById('apiUrl').value;
            if (!apiUrl) {
                showError('apiUrl', 'API 地址不能为空');
                isValid = false;
            } else if (!isValidUrl(apiUrl)) {
                showError('apiUrl', '请输入有效的 URL');
                isValid = false;
            }
            
            // 验证 API Key
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                showError('apiKey', 'API 密钥不能为空');
                isValid = false;
            }
            
            // 验证自定义请求头
            const headers = document.getElementById('headers').value;
            if (headers && !isValidJson(headers)) {
                showError('headers', '请输入有效的 JSON 格式');
                isValid = false;
            }
            
            if (isValid) {
                saveConfig();
            }
        }
        
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        function isValidJson(string) {
            try {
                JSON.parse(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        function showError(fieldId, message) {
            const errorElement = document.getElementById(fieldId + '-error');
            if (errorElement) {
                errorElement.textContent = message;
            }
        }
        
        function clearErrors() {
            const errors = document.querySelectorAll('.error');
            errors.forEach(error => error.textContent = '');
        }
        
        function saveConfig() {
            const formData = new FormData(form);
            const config = {};
            
            for (let [key, value] of formData.entries()) {
                if (key === 'headers' && value) {
                    config[key] = JSON.parse(value);
                } else if (key === 'enableCache') {
                    config[key] = value === 'on';
                } else if (key === 'timeout' || key === 'cacheExpiry' || key === 'retryCount') {
                    config[key] = parseInt(value);
                } else {
                    config[key] = value;
                }
            }
            
            // 发送配置到父窗口
            if (window.parent) {
                window.parent.postMessage({
                    type: 'pluginConfigSave',
                    config: config
                }, '*');
            }
        }
        
        // 加载现有配置
        function loadConfig(config) {
            if (!config) return;
            
            Object.keys(config).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = config[key];
                    } else if (key === 'headers' && config[key]) {
                        element.value = JSON.stringify(config[key], null, 2);
                    } else {
                        element.value = config[key];
                    }
                }
            });
            
            // 触发缓存选项显示
            enableCacheCheckbox.dispatchEvent(new Event('change'));
        }
        
        // 监听配置加载消息
        window.addEventListener('message', function(e) {
            if (e.data.type === 'pluginConfigLoad') {
                loadConfig(e.data.config);
            }
        });
    </script>
</body>
</html>
```

## 插件测试

### 1. 单元测试

编写单元测试：

```typescript
// tests/unit/main.test.ts
import { MainHandler } from '../../src/handlers/main';
import { PluginContext } from '@fastgpt/plugin-sdk';

describe('MainHandler', () => {
  let handler: MainHandler;
  let context: PluginContext;

  beforeEach(() => {
    context = {
      pluginId: 'test-plugin',
      userId: 'test-user',
      requestId: 'test-request'
    };

    const config = {
      apiUrl: 'https://api.example.com',
      apiKey: 'test-key',
      timeout: 30,
      enableCache: true,
      cacheExpiry: 60,
      retryCount: 2
    };

    handler = new MainHandler(config, context);
  });

  test('should execute successfully with valid input', async () => {
    const input = {
      data: {
        query: 'test query',
        parameters: { type: 'search' },
        options: { format: 'json', method: 'GET' }
      }
    };

    // Mock HTTP request
    jest.spyOn(require('axios'), 'default').mockResolvedValue({
      data: { results: ['test result'] }
    });

    const result = await handler.execute(input);

    expect(result.success).toBe(true);
    expect(result.data).toEqual({ results: ['test result'] });
  });

  test('should handle invalid input', async () => {
    const input = {
      data: {
        query: '', // Empty query
        parameters: {},
        options: {}
      }
    };

    const result = await handler.execute(input);

    expect(result.success).toBe(false);
    expect(result.error.message).toContain('查询参数不能为空');
  });
});
```

### 2. 集成测试

```typescript
// tests/integration/plugin.test.ts
import { PluginRunner } from '@fastgpt/plugin-sdk';
import plugin from '../../src/index';

describe('Plugin Integration', () => {
  let runner: PluginRunner;

  beforeEach(() => {
    runner = new PluginRunner(plugin);
  });

  test('should load plugin configuration', () => {
    const config = runner.getConfig();
    expect(config.id).toBe('my-custom-plugin');
    expect(config.version).toBe('1.0.0');
  });

  test('should validate configuration schema', () => {
    const validConfig = {
      apiUrl: 'https://api.example.com',
      apiKey: 'test-key',
      timeout: 30
    };

    const result = runner.validateConfig(validConfig);
    expect(result.valid).toBe(true);
  });
});
```

## 插件构建和发布

### 1. 构建插件

```bash
# 运行测试
npm test

# 类型检查
npm run type-check

# 构建插件
npm run build

# 生成插件包
npm run package
```

### 2. 发布准备

发布前检查清单：

- [ ] 完善的文档
- [ ] 充分的测试覆盖
- [ ] 正确的版本号
- [ ] 许可证信息
- [ ] 安全审查

### 3. 插件发布

```bash
# 发布到插件市场
fastgpt-plugin publish

# 或者生成离线安装包
fastgpt-plugin pack
```

## 最佳实践

### 1. 错误处理

- 提供详细的错误信息
- 区分可重试和不可重试的错误
- 记录错误日志便于调试

### 2. 性能优化

- 使用缓存减少重复请求
- 实现连接池管理
- 异步处理避免阻塞

### 3. 安全考虑

- 验证所有输入数据
- 安全存储敏感信息
- 使用 HTTPS 通信

### 4. 用户体验

- 提供清晰的配置界面
- 编写详细的使用文档
- 提供有用的错误提示

## 常见问题

### Q: 如何调试插件？

A: 可以使用以下方法调试：
- 使用 console.log 输出调试信息
- 使用 VS Code 的调试功能
- 查看插件运行日志

### Q: 插件如何访问外部资源？

A: 需要在插件定义中声明相应的权限，如 `http.request`、`file.read` 等。

### Q: 如何处理插件的依赖关系？

A: 在 package.json 中声明依赖，构建时会自动打包。

### Q: 插件如何与 FastGPT 核心功能集成？

A: 通过 SDK 提供的 API 可以访问知识库、用户信息等核心功能。

## 相关文档

- [插件 API 参考](./插件API参考.md)
- [插件示例](./插件示例.md)
- [插件市场](./插件市场.md)
- [开发工具](./开发工具.md)

