---
title: 代码运行
description: FastGPT 代码运行节点介绍
sidebar_position: 18
---

# 代码运行

<!-- 代码运行模块界面图 -->

## 功能

可用于执行一段简单的 JavaScript 代码，用于进行一些复杂的数据处理。代码运行在沙盒中，无法进行网络请求、DOM操作和异步操作。如需复杂操作，需外挂 HTTP 实现。

**注意事项**

- 私有化用户需要部署`fastgpt-sandbox` 镜像，并配置`SANDBOX_URL`环境变量
- 沙盒最大运行 10s， 32M 内存限制

## 变量输入 

可在自定义输入中添加代码运行需要的变量，在代码的 main 函数中，可解构出相同名字的变量。

如上图，自定义输入中有 data1 和 data2 两个变量，main 函数中可以解构出相同名字的变量。

## 结果输出

务必返回一个 object 对象，对象的 key 将作为变量输出。

## 使用场景

### 数据计算

进行复杂的数学计算和数据处理：

```javascript
function main({ price, quantity, discount }) {
  // 计算订单总金额
  const subtotal = price * quantity;
  const discountAmount = subtotal * (discount / 100);
  const total = subtotal - discountAmount;
  const tax = total * 0.1; // 10%税率
  const finalTotal = total + tax;
  
  return {
    subtotal: subtotal,
    discountAmount: discountAmount,
    tax: tax,
    total: finalTotal,
    savings: discountAmount
  };
}
```

### 数据转换

转换数据格式和结构：

```javascript
function main({ userData }) {
  // 将用户数据转换为标准格式
  const users = JSON.parse(userData);
  
  const transformedData = users.map(user => ({
    id: user.id,
    fullName: `${user.firstName} ${user.lastName}`,
    email: user.email.toLowerCase(),
    age: new Date().getFullYear() - new Date(user.birthDate).getFullYear(),
    status: user.isActive ? 'active' : 'inactive'
  }));
  
  return {
    processedUsers: transformedData,
    totalCount: transformedData.length,
    activeCount: transformedData.filter(u => u.status === 'active').length
  };
}
```

### 文本处理

处理和分析文本内容：

```javascript
function main({ text }) {
  // 文本分析和处理
  const words = text.toLowerCase().split(/\s+/);
  const wordCount = words.length;
  const uniqueWords = [...new Set(words)].length;
  const avgWordLength = words.reduce((sum, word) => sum + word.length, 0) / wordCount;
  
  // 提取关键词（长度大于4的词）
  const keywords = words.filter(word => word.length > 4);
  
  // 词频统计
  const wordFreq = {};
  words.forEach(word => {
    wordFreq[word] = (wordFreq[word] || 0) + 1;
  });
  
  return {
    wordCount: wordCount,
    uniqueWords: uniqueWords,
    avgWordLength: Math.round(avgWordLength * 100) / 100,
    keywords: keywords,
    topWords: Object.entries(wordFreq)
      .sort(([,a], [,b]) => b - a)
      .slice(0, 5)
      .map(([word, count]) => ({ word, count }))
  };
}
```

## 代码示例

### 数组处理

```javascript
function main({ numbers }) {
  // 处理数字数组
  const nums = numbers.map(Number);
  
  const sum = nums.reduce((a, b) => a + b, 0);
  const avg = sum / nums.length;
  const max = Math.max(...nums);
  const min = Math.min(...nums);
  const median = [...nums].sort((a, b) => a - b)[Math.floor(nums.length / 2)];
  
  return {
    sum: sum,
    average: avg,
    maximum: max,
    minimum: min,
    median: median,
    count: nums.length
  };
}
```

### 日期时间处理

```javascript
function main({ dateString, timezone }) {
  // 日期时间处理
  const date = new Date(dateString);
  
  // 获取各种格式的日期
  const formats = {
    iso: date.toISOString(),
    date: date.toDateString(),
    locale: date.toLocaleString(),
    year: date.getFullYear(),
    month: date.getMonth() + 1,
    day: date.getDate(),
    weekday: date.toLocaleDateString('zh-CN', { weekday: 'long' })
  };
  
  // 计算相对时间
  const now = new Date();
  const diffMs = now - date;
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  
  return {
    formats: formats,
    daysAgo: diffDays,
    timestamp: date.getTime(),
    isToday: diffDays === 0,
    isFuture: diffMs < 0
  };
}
```

### JSON数据处理

```javascript
function main({ jsonData, filterKey, filterValue }) {
  // JSON数据过滤和处理
  const data = JSON.parse(jsonData);
  
  // 过滤数据
  const filtered = data.filter(item => 
    item[filterKey] && item[filterKey].toString().includes(filterValue)
  );
  
  // 统计信息
  const stats = {
    totalRecords: data.length,
    filteredRecords: filtered.length,
    filterRate: (filtered.length / data.length * 100).toFixed(2) + '%'
  };
  
  // 分组统计
  const groupBy = {};
  filtered.forEach(item => {
    const key = item[filterKey];
    groupBy[key] = (groupBy[key] || 0) + 1;
  });
  
  return {
    filteredData: filtered,
    statistics: stats,
    groupedStats: groupBy,
    summary: `找到 ${filtered.length} 条匹配记录`
  };
}
```

### 字符串操作

```javascript
function main({ inputText, operation }) {
  // 多种字符串操作
  let result = inputText;
  
  switch (operation) {
    case 'uppercase':
      result = inputText.toUpperCase();
      break;
    case 'lowercase':
      result = inputText.toLowerCase();
      break;
    case 'title':
      result = inputText.replace(/\w\S*/g, (txt) => 
        txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
      );
      break;
    case 'reverse':
      result = inputText.split('').reverse().join('');
      break;
    case 'clean':
      result = inputText.replace(/[^\w\s]/gi, '').replace(/\s+/g, ' ').trim();
      break;
  }
  
  return {
    original: inputText,
    processed: result,
    operation: operation,
    length: result.length,
    changed: inputText !== result
  };
}
```

## 高级应用

### 数据验证

```javascript
function main({ formData }) {
  // 表单数据验证
  const errors = [];
  const warnings = [];
  
  // 邮箱验证
  if (!formData.email || !/\S+@\S+\.\S+/.test(formData.email)) {
    errors.push('邮箱格式不正确');
  }
  
  // 手机号验证
  if (!formData.phone || !/^1[3-9]\d{9}$/.test(formData.phone)) {
    errors.push('手机号格式不正确');
  }
  
  // 年龄验证
  if (formData.age < 18) {
    warnings.push('用户未满18岁');
  }
  
  // 密码强度检查
  const password = formData.password;
  let strength = 0;
  if (password.length >= 8) strength++;
  if (/[A-Z]/.test(password)) strength++;
  if (/[a-z]/.test(password)) strength++;
  if (/\d/.test(password)) strength++;
  if (/[^A-Za-z0-9]/.test(password)) strength++;
  
  return {
    isValid: errors.length === 0,
    errors: errors,
    warnings: warnings,
    passwordStrength: strength,
    strengthText: ['很弱', '弱', '一般', '强', '很强'][strength] || '无效'
  };
}
```

### 业务逻辑计算

```javascript
function main({ orderData, customerLevel, promotionCode }) {
  // 复杂的业务逻辑计算
  let totalAmount = orderData.items.reduce((sum, item) => 
    sum + (item.price * item.quantity), 0
  );
  
  // 会员折扣
  const discounts = {
    'bronze': 0.05,
    'silver': 0.10,
    'gold': 0.15,
    'platinum': 0.20
  };
  
  const memberDiscount = discounts[customerLevel] || 0;
  const memberDiscountAmount = totalAmount * memberDiscount;
  
  // 促销码折扣
  const promotions = {
    'SAVE10': 0.10,
    'SAVE20': 0.20,
    'NEWUSER': 0.15
  };
  
  const promoDiscount = promotions[promotionCode] || 0;
  const promoDiscountAmount = totalAmount * promoDiscount;
  
  // 计算最终金额
  const subtotal = totalAmount;
  const totalDiscount = memberDiscountAmount + promoDiscountAmount;
  const discountedAmount = subtotal - totalDiscount;
  const shipping = discountedAmount > 100 ? 0 : 10; // 满100免运费
  const tax = discountedAmount * 0.08; // 8%税率
  const finalAmount = discountedAmount + shipping + tax;
  
  return {
    subtotal: subtotal,
    memberDiscount: memberDiscountAmount,
    promoDiscount: promoDiscountAmount,
    totalDiscount: totalDiscount,
    shipping: shipping,
    tax: tax,
    finalAmount: Math.round(finalAmount * 100) / 100,
    savings: totalDiscount
  };
}
```

## 最佳实践

### 错误处理

```javascript
function main({ data }) {
  try {
    // 主要逻辑
    const result = processData(data);
    return {
      success: true,
      data: result,
      error: null
    };
  } catch (error) {
    return {
      success: false,
      data: null,
      error: error.message
    };
  }
}

function processData(data) {
  if (!data) throw new Error('数据不能为空');
  // 处理逻辑...
}
```

### 性能优化

```javascript
function main({ largeArray }) {
  // 处理大数组时的优化
  const batchSize = 1000;
  const results = [];
  
  for (let i = 0; i < largeArray.length; i += batchSize) {
    const batch = largeArray.slice(i, i + batchSize);
    const batchResult = processBatch(batch);
    results.push(...batchResult);
  }
  
  return {
    processedCount: results.length,
    results: results
  };
}
```

## 限制说明

### 功能限制

- **网络请求**：无法发起HTTP请求
- **文件系统**：无法访问文件系统
- **异步操作**：不支持异步操作（Promise、async/await）
- **DOM操作**：无法操作DOM元素
- **外部库**：无法引入外部库和模块

### 资源限制

- **执行时间**：最长10秒
- **内存使用**：最大32MB
- **计算复杂度**：避免过于复杂的计算

### 安全限制

- **沙盒运行**：代码在安全沙盒中运行
- **权限控制**：无法访问系统资源
- **代码检查**：恶意代码会被拦截

## 注意事项

1. **返回格式**：必须返回Object对象，不能返回原始类型
2. **变量命名**：输入变量名要与参数名保持一致
3. **错误处理**：做好异常处理，避免代码崩溃
4. **性能考虑**：避免死循环和过度计算
5. **调试方法**：可以返回调试信息帮助排查问题
6. **版本兼容**：使用ES5/ES6标准语法，避免最新特性
